# 今週何知った？ week:7

[![hackmd-github-sync-badge](https://hackmd.io/CFlTER5rRHy37AW44sisZw/badge)](https://hackmd.io/CFlTER5rRHy37AW44sisZw)

> [name=makicamel]

## Redis

- [Redis 入門](https://www.amazon.co.jp/dp/4048917358) を読んでいる

### トランザクション

Redis にはトランザクション操作のためのコマンドがある  
- `WATCH`
- `MULTI` ~ `EXEC`  
`MULTI` が呼ばれると `EXEC` が呼ばれるまで同じ接続先からのコマンドをメモリにキューイングし続け、 `EXEC` が呼ばれるとキューイングされたコマンドを中断なくシーケンシャルに実行する
- `UNWATCH`
- `DISCARD`

#### Redis の基本トランザクションとは
- リレーショナルデータベースのトランザクション  
部分的な実行を許さず、ロールバック or コミットのどちらかを行う
- Redis のトランザクション  
ほかのクライアントからの割り込みなく複数のコマンドを実行する

#### Redis のトランザクションの目的
- レースコンディション防止
- パフォーマンス向上  
Redis サーバ - クライアント間のラウンドトリップ回数の低減  
    - [Redisクエリを高速化するためのパイプラインの利用 – Redis 日本語訳](http://mogile.web.fc2.com/redis/topics/pipelining.html)
    - 原文：[Using pipelining to speedup Redis queries – Redis](https://redis.io/topics/pipelining)

### 永続化
Redis の永続化の方法はふたつある
- スナップショット  
ある瞬間のデータを取り出してディスクに書き出す。デフォルトで有効。 5 種類の方法がある  
スナップショットを開始しても終了までに Redis サーバがクラッシュすればその間のデータは失われる
- 追記専用ファイル（AOF）  
書き込みコマンドを受け取った時にディスクにコピーする。更新系処理のパフォーマンスは下がる  
ElastiCache ではこちらが利用可能だが、バックアップよりも Multi-AZ のレプリカ構成が推奨されている  
  また AOF のファイルサイズは膨大で、すべてのコマンドを実行するため Redis の再起動が遅くなる場合があるというデメリットがある
![](https://i.imgur.com/bRECjbG.jpg)
    - [ElastiCache for Redis でファイルのみを追加する (AOF) - Amazon ElastiCache for Redis](https://docs.aws.amazon.com/ja_jp/AmazonElastiCache/latest/red-ug/RedisAOF.html)
    - [障害の軽減 - Amazon ElastiCache for Redis](https://docs.aws.amazon.com/ja_jp/AmazonElastiCache/latest/red-ug/FaultTolerance.html#FaultTolerance.Redis) 
    
データをディスクに永続化することは重要だが、データ消失を防ぐにはさらにそのデータのバックアップが必要となる。  
もし負荷が重い、データ完全性の要件が厳格である場合はレプリケーションを検討する必要がある

### レプリケーション

- レプリケーションとは  
更新されたデータが書き込まれる度にほかのサーバーが継続的にその更新データのコピーを受け取り、読み出しクエリに応答できるようにするもの
- スレーブがマスターに接続したときに起きること
![](https://i.imgur.com/MZaEvza.jpg)
- 読み出し負荷が書き込み負荷を大きく上回った場合、並列にスレーブを増やすのではなく中間層を設けてレプリケーションの負荷を軽くすることができる
![](https://i.imgur.com/vpKNcid.jpg)
  - ref Amazon ElastiCache [Redis シャードの構成](https://docs.aws.amazon.com/ja_jp/AmazonElastiCache/latest/red-ug/Shards.html)  
  ![](https://i.imgur.com/uNTLDHb.png)
  ElastiCache の場合対応方針としてシャーディングに注力しているように見える  
  レプリカ or マスタを増やすにより以下のような最大シャード構成を取りうる
    - 最大 90 ノード / クラスタ
    - 最大 6 ノード / シャード
      - 6 ノード（1 マスター + 5 レプリカ） * 15 シャード
      - 1 ノード（1 マスター + 0 レプリカ） * 90 シャード

  - ref [week: 1 Redis におけるシャード・ノード](https://github.com/makicamel/wwk/blob/main/20211213.md#redis-におけるシャードノード) 


# 副業をはじめるにあたってお金周りで気になる点を調べた

 ## 1. 経費と領収書
### 気になりポイント
- 「経費で落とす」ってよく聞くけどなに？どれぐらい得になるの？

### 経費概要
- そもそも経費とは：事業で利益を生み出すためにかかったお金のこと
- 何が経費になるか
    - 基本的には自分の仕事に関連していればOK
    - 判断は税務調査官による。利益を生み出すために利用されたか、がポイント
- 会社員の経費と個人事業主の経費
    - 会社員…すべて会社の支払い。100%お金は戻ってくる
    - 経費に認定されたものは、大体額面の15%ぐらいお得になる
        - どう得になるか
            - 課税所得 = 所得 - 経費。そのため経費が計上されるほど、課税額が減る
            - 家賃やインターネット料金なども「家事按分」という形で、利用割合に応じた計上ができる

## 2. 確定申告

### 気になりポイント
- 副業で20万円超えた場合は、なんかしないといけないらしいじゃん？
- この時期フリーランスのひと忙しそうにしているけど、そのわけは？
### 確定申告とは
- 一年間の所得をとりまとめて、国に収める税額を報告すること
#### 行う必要のない人
- 年収2,000万円以下
- 1か所からしか給与をもらっていない
- 副業での所得が年間20万円以下

それ以外の人は確定申告を行う必要がある
（会社員の場合は会社が年末調整という形で個人にかわり確定申告を行なっている）

### 確定申告をするメリット
- 源泉徴収で引かれすぎた税金が戻ってくる可能性がある
- 課税所得を調整することができる

### 申告方法
- 白色申告と青色申告の二つがある

||白色申告|青色申告|
| --- | --- | --- |
| 記帳方法 | 単式簿記 | 複式簿記 |
| 控除額 | 10万 | 55万(65万) |
| 赤字の繰越 | できない | 3年まで可 |
| 減価償却 | 一括10万円まで | 一括30万円まで |

### 青色申告を利用するのに必要な書類
#### 1. 開業届
- これこれこういう事業をやりますよと税務署に申告する必要がある

#### 2.  「所得税の青色申告承認申請書」
- 青色申告で税申告することを税務署に承認してもらうための書類

#### 3. 「青色申告決算書」 & 「確定申告書B」
- 2月16日 ~ 3月15日が〆切（なのでTwitter界隈ではこの時期よくわたわたしている人がいる）

### 青色申告に利用する複式簿記を記帳できるアプリ
- MoneyForward
- freee
- やよいの青色申告

### メモ
- [ADR](https://blog.studysapuri.jp/entry/architecture_decision_records)